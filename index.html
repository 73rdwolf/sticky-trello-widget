<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sticky Trello Wallpaper</title>
    <style>
        :root {
            --bg: rgba(20, 20, 20, 0.7);
            --text: #ffffff;
            --accent: #0079bf;
            --accent-hover: #026aa7;
            --danger: #eb5a46;
            --input-bg: #333;
            --rounded: 12px;
            --toolbar-bg: rgba(40, 40, 40, 0.9);
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background: transparent;
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #onboarding {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            background: var(--bg);
            border-radius: var(--rounded);
            margin: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #trello-webview {
            display: none;
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
        }

        /* Toolbar */
        #toolbar {
            position: absolute;
            top: 60px;
            /* Below drag region */
            left: 20px;
            display: none;
            background: var(--toolbar-bg);
            padding: 8px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: opacity 0.3s;
            opacity: 0.2;
        }

        #toolbar:hover {
            opacity: 1;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 5px 12px;
            margin: 0 2px;
            cursor: pointer;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .nav-btn.switch {
            background: var(--accent);
        }

        .nav-btn.switch:hover {
            background: var(--accent-hover);
        }

        .drag-region {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            -webkit-app-region: drag;
            z-index: 1000;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            color: #888;
            cursor: pointer;
            z-index: 1001;
            transition: color 0.2s;
            -webkit-app-region: no-drag;
        }

        .close-btn:hover {
            color: #fff;
        }

        .container {
            width: 100%;
            max-width: 500px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        p {
            color: #ccc;
            margin-bottom: 25px;
            font-size: 15px;
            line-height: 1.5;
        }

        input {
            width: 100%;
            padding: 16px;
            margin-bottom: 20px;
            border: 2px solid transparent;
            border-radius: 10px;
            background: var(--input-bg);
            color: white;
            box-sizing: border-box;
            outline: none;
            font-size: 16px;
        }

        input:focus {
            border-color: var(--accent);
        }

        button.start-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 18px;
        }

        button.start-btn:hover {
            background: var(--accent-hover);
        }

        #widget-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>

<body>
    <div id="widget-container">
        <div class="drag-region"></div>
        <div class="close-btn" id="close-btn">√ó</div>

        <!-- Float Toolbar for Navigation -->
        <div id="toolbar">
            <button class="nav-btn" onclick="goBack()">‚Üê Back</button>
            <button class="nav-btn" onclick="reload()">‚Üª Refresh</button>
            <button class="nav-btn" onclick="goHome()">üè† Home</button>
            <button class="nav-btn switch" onclick="switchBoard()">‚áÑ Switch Board</button>
        </div>

        <div id="onboarding">
            <div class="container">
                <h1>Trello Wallpaper</h1>
                <p>Enter your Trello board URL. <br>To log in or create boards, just use the Trello interface after
                    connecting.</p>
                <input type="text" id="url-input" placeholder="https://trello.com/b/...">
                <button class="start-btn" id="start-btn">Connect & Stick</button>
            </div>
        </div>

        <webview id="trello-webview" partition="persist:trello" allowpopups></webview>
    </div>

    <script>
        const onboarding = document.getElementById('onboarding');
        const webview = document.getElementById('trello-webview');
        const toolbar = document.getElementById('toolbar');
        const urlInput = document.getElementById('url-input');
        const startBtn = document.getElementById('start-btn');
        const closeBtn = document.getElementById('close-btn');

        async function init() {
            const config = await window.electronAPI.getConfig();
            if (config.trelloUrl) {
                loadBoard(config.trelloUrl);
            }
        }

        function loadBoard(url) {
            onboarding.style.display = 'none';
            webview.style.display = 'flex';
            toolbar.style.display = 'flex';
            webview.src = url;

            webview.addEventListener('dom-ready', () => {
                // CSS to remove ONLY the board background, preserving all UI elements
                const css = `
                    /* ============================================
                       TARGETED BOARD BACKGROUND REMOVAL
                       Only affects the main board background layer.
                       Cards, modals, lists, and settings stay opaque.
                       ============================================ */

                    /* Main board background container - the customizable wallpaper area */
                    [data-testid="board-background"],
                    .board-background,
                    #board-background,
                    .board-wrapper > div:first-child,
                    [class*="BoardBackground"],
                    [class*="board-background"] {
                        background: transparent !important;
                        background-color: transparent !important;
                        background-image: none !important;
                    }

                    /* Board canvas (where lists sit) */
                    .board-canvas,
                    [data-testid="board-canvas"],
                    .board-main-content {
                        background: transparent !important;
                        background-color: transparent !important;
                        background-image: none !important;
                    }

                    /* Top-level containers that hold the background */
                    #trello-root,
                    #surface,
                    #content,
                    #chrome-container,
                    body,
                    html {
                        background: transparent !important;
                        background-color: transparent !important;
                    }

                    /* Hide the Atlassian header */
                    #header,
                    [data-testid="atlassian-navigation"],
                    .atlassian-navigation,
                    nav[aria-label="Atlassian Navigation"] {
                        display: none !important;
                    }

                    /* ============================================
                       PRESERVE THESE UI ELEMENTS (Keep opaque)
                       ============================================ */

                    /* Card modals and dialogs - KEEP THEIR BACKGROUNDS */
                    .window-overlay,
                    .window-module,
                    .card-detail-window,
                    [data-testid="card-back"],
                    [data-testid="card-detail"],
                    .pop-over,
                    .dialog,
                    .modal,
                    [role="dialog"],
                    [role="alertdialog"] {
                        /* Do NOT set transparent here - let Trello's styles apply */
                    }

                    /* Lists and cards */
                    .list-wrapper,
                    .list-card,
                    .list-header,
                    [data-testid="list"],
                    [data-testid="list-wrapper"],
                    [data-testid="card"] {
                        /* Do NOT set transparent - keep Trello's styling */
                    }

                    /* Buttons, inputs, and other controls */
                    button, input, select, textarea, .button, .btn {
                        /* Preserve default styling */
                    }
                `;
                webview.insertCSS(css);

                // JavaScript to remove ONLY the board background inline styles
                webview.executeJavaScript(`
                    function removeBoardBackground() {
                        // Target ONLY board background elements
                        const boardBackgroundSelectors = [
                            '[data-testid="board-background"]',
                            '.board-background',
                            '#board-background',
                            '[class*="BoardBackground"]',
                            '[class*="board-background"]'
                        ];

                        boardBackgroundSelectors.forEach(selector => {
                            document.querySelectorAll(selector).forEach(el => {
                                el.style.setProperty('background', 'transparent', 'important');
                                el.style.setProperty('background-color', 'transparent', 'important');
                                el.style.setProperty('background-image', 'none', 'important');
                            });
                        });

                        // Also check for elements with background-image set inline (board photos)
                        const main = document.querySelector('#trello-root') || document.body;
                        const allDivs = main.querySelectorAll('div');
                        allDivs.forEach(el => {
                            const style = el.style;
                            const className = el.className || '';
                            const testId = el.getAttribute('data-testid') || '';

                            // Check if this is likely a board background element
                            const isBoardBg = (
                                testId.includes('board-background') ||
                                testId.includes('board-wrapper') ||
                                className.includes('board-background') ||
                                className.includes('BoardBackground')
                            );

                            // Skip if it's a card, list, modal, or other UI element
                            const isUIElement = (
                                className.includes('card') ||
                                className.includes('list') ||
                                className.includes('modal') ||
                                className.includes('dialog') ||
                                className.includes('pop-over') ||
                                className.includes('window') ||
                                testId.includes('card') ||
                                testId.includes('list') ||
                                el.closest('[role="dialog"]') ||
                                el.closest('.pop-over')
                            );

                            if (isBoardBg && !isUIElement) {
                                style.setProperty('background', 'transparent', 'important');
                                style.setProperty('background-color', 'transparent', 'important');
                                style.setProperty('background-image', 'none', 'important');
                            }
                        });
                    }

                    // Run multiple times to catch dynamic loads
                    removeBoardBackground();
                    setTimeout(removeBoardBackground, 500);
                    setTimeout(removeBoardBackground, 1500);
                    setTimeout(removeBoardBackground, 3000);

                    // Observe for dynamic changes
                    const observer = new MutationObserver(() => {
                        removeBoardBackground();
                    });
                    observer.observe(document.body, { childList: true, subtree: true, attributes: true });
                `);
            });







        }

        function goBack() { if (webview.canGoBack()) webview.goBack(); }
        function reload() { webview.reload(); }
        function goHome() { webview.src = 'https://trello.com'; } // Goes to Trello dashboard/login
        function switchBoard() {
            onboarding.style.display = 'flex';
            webview.style.display = 'none';
            toolbar.style.display = 'none';
        }

        startBtn.onclick = () => {
            const url = urlInput.value.trim();
            if (url.startsWith('http')) {
                window.electronAPI.saveUrl(url);
                loadBoard(url);
            }
        };

        closeBtn.onclick = () => window.electronAPI.closeApp();
        init();
    </script>
</body>

</html>